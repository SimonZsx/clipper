# docker build -f ./imagequery_w_proxy/Dockerfile4 -t imagequery_w_proxy:c4 .
# docker run -p 11000:11000 --runtime=nvidia -it imagequery_w_proxy:c4

# Ubuntu16.04 does not support python3.6 natively.
# Default python3 for Ubuntu16.04 is python3.5, while
# default python3 for Ubuntu18.04 is python3.6.
FROM nvidia/cuda:10.0-base-ubuntu18.04
RUN apt-get update && apt-get install git wget unzip curl -y
RUN apt-get update && apt-get install python3 python3-pip -y

RUN pip3 install https://download.pytorch.org/whl/cu100/torch-1.1.0-cp36-cp36m-linux_x86_64.whl
RUN pip3 install https://download.pytorch.org/whl/cu100/torchvision-0.3.0-cp36-cp36m-linux_x86_64.whl

# Equivalent to: pip3 install -r requirements.txt
RUN pip3 install numpy msgpack-python spacy==1.9.0 

ADD imagequery_w_proxy/c4_questionAnswering/app /container
# RUN pip3 install -r requirements.txt # Listed above for quicker building
WORKDIR /container
RUN chmod 777 ./download_python3.sh && ./download_python3.sh
RUN python3 prepro.py
WORKDIR /container/models
ADD imagequery_w_proxy/c4_questionAnswering/downloadModels.sh .
RUN chmod 777 ./downloadModels.sh && ./downloadModels.sh

# RUN pip3 install grpcio
# RUN pip3 install protobuf
# ADD grpc/app/container_entry.sh /container/
# ADD grpc/app/server.py /container/
# ADD grpc/app/model_pb2_grpc.py /container/
# ADD grpc/app/model_pb2.py /container/
# ADD grpc/app/proxy_pb2_grpc.py /container/
# ADD grpc/app/proxy_pb2.py /container/

# CMD ["/container/container_entry.sh", "c4", "/container/server.py"]
# CMD ["python","/container/predict.py"]

EXPOSE 11000